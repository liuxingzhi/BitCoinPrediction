---
title: "STAT 420-finalproject"
author: "Siyu Niu Han Jiang Xinyi Peng Xingzhi Liu"
date: "2020/5"
output: html_document
---



```{r setup, echo = FALSE, message = FALSE, warning = FALSE}
options(scipen = 1, digits = 4, width = 80)
library(knitr)
opts_chunk$set(cache = TRUE, autodep = TRUE)
```




# Financial and risk management in applied statistics with R




# Introduction 
The introduction section should relay what you are attempting to accomplish. It would include a statement of the business, science, research, or personal interest you have that leads to analyzing the data you’ve chosen. It should provide enough background to your work such that a reader would not need to load your data to understand your report. Like the simulation project, you can assume the reader is familiar with the course concepts, but not your data. Some things to consider:

What is this data? Where did it come from? What are the variables? Why is it interesting to you?
Why are you creating a model for this data? What is the goal of this model?


# Methods 

The methods section should contain the bulk of your “work.” This section will contain the bulk of the R code that is used to generate the results. Your R code is not expected to be perfect idiomatic R, but it is expected to be understood by a reader without too much effort. Use RMarkdown and code comments to your advantage to explain your code if needed.

This section should contain any information about data preparation that is performed to the original data before modelling. Then you will apply methods seen in class, which may include some of the following but are not limited to:

Multiple linear regression
Dummy variables
Interaction
Residual diagnostics
Outlier diagnostics
Transformations
Polynomial regression
Model selection
Your task is not to use as many methods as possible. Your task is to use appropriate methods to find a good model that can correctly answer a question about the dataset, and then to communicate your result effectively. Some possible items to be discussed:

Description of the original data file including description of all relevant variables.
Description of additional data preparation that you performed.
Description of the process you chose to follow.
Narrative of your step-by-step decision making process throughout the analysis as you adjusted the model and attempted to validate model assumptions.
```{r}
# install necessary packages
# install.packages("readxl")
# install.packages("sqldf")
# install.packages("corrplot")
```

```{r}
library(readr)
library("readxl")
library(sqldf)
library(glue)
library("corrplot")
options(digits=6)
```

# data clean
```{r}
# price of bitcoin
Bitcoin <- read_csv("Bitcoin Historical Data - Investing.com.csv")
Bitcoin$Date = as.Date(Bitcoin$Date, format="%b %d, %Y")
Bitcoin$month <- strftime(Bitcoin$Date, "%m")
Bitcoin$year <- strftime(Bitcoin$Date, "%Y")
plot(Price ~ Date, data=Bitcoin, type = "l")
```
```{r}
President <- read_csv("President.csv")
President$Date = as.Date(President$Date, format="%b %d, %Y")
plot(president_code ~ Date, data=President)
```

```{r}
The_interest_rate_for_the_United_States<- read_csv("The interest rate for the United States, from 2010 - 2020.csv")
The_interest_rate_for_the_United_States$month <- strftime(The_interest_rate_for_the_United_States$Date, "%m")
The_interest_rate_for_the_United_States$year <- strftime(The_interest_rate_for_the_United_States$Date, "%Y")
plot(interest_rate ~ Date, data=The_interest_rate_for_the_United_States, type = "o")
```

```{r}
US_dollar_yuan_exchange_rate <- read_csv("US dollar-yuan exchange rate.csv")
US_dollar_yuan_exchange_rate$Date = as.Date(US_dollar_yuan_exchange_rate$Date, format="%m/%d/%y")
plot(exchange_rate ~ Date, data = US_dollar_yuan_exchange_rate, type = 'l')

Euro_to_US_exchange_rate <- read_csv("euro-dollar-exchange-rate-historical-chart.csv")
Euro_to_US_exchange_rate$Date = as.Date(Euro_to_US_exchange_rate$Date, format="%m/%d/%y")
Euro_to_US_exchange_rate$exchange_rate = 1/Euro_to_US_exchange_rate$exchange_rate
plot(exchange_rate  ~ Date, data = Euro_to_US_exchange_rate, type = 'l')
```
```{r}
Gold <- read_csv("Gold Futures Historical Data.csv")
Gold$Date = as.Date(Gold$Date, format="%b %d, %Y")
plot(Price ~ Date, data=Gold, type='l')
```
This dataset we will use the Volume and Price columns.
```{r}
Dow_Jones_Industrial_Average <- read_csv("Dow Jones Industrial Average Historical Data.csv")
Dow_Jones_Industrial_Average$Date = as.Date(Dow_Jones_Industrial_Average$Date, format="%b %d, %Y")
plot(Price ~ Date, data=Dow_Jones_Industrial_Average, type = 'l')
```
```{r}
NYSE_Composite_Index <- read_csv("NYSE Composite Historical Data.csv")
NYSE_Composite_Index$Date = as.Date(NYSE_Composite_Index$Date, format="%b %d, %Y")
plot(Price ~ Date, data=NYSE_Composite_Index, type = 'l')
```


```{r}
Apple_Inc_company_stock <- read_csv("AAPL Historical Data.csv")
Apple_Inc_company_stock$Date = as.Date(Apple_Inc_company_stock$Date, format="%b %d, %Y")
plot(Price ~ Date, data=Apple_Inc_company_stock, type = 'l')
```
This dataset we will use the Adj Close and volume columns.

```{r}
WTI_oil_price <- read_csv("Crude Oil WTI Futures Historical Data.csv")
WTI_oil_price$Date = as.Date(WTI_oil_price$Date, format="%b %d, %Y")
# colnames(WTI_oil_price)[2] <- "WTI_oil_price"
plot(Price ~ Date, data=WTI_oil_price)

Brent_Oil_price <- read_csv("Brent Oil Futures Historical Data.csv")
Brent_Oil_price$Date = as.Date(Brent_Oil_price$Date, format="%b %d, %Y")
# colnames(Brent_Oil_price)[2] <- "Brent_oil_price"
plot(Price ~ Date, data=Brent_Oil_price, type = 'l')
```

```{r}
# combine
# Reduce(function(...) merge(..., by="Date"), list(Brent_Oil_price, Crude_Oil_price, Apple_compact))
sql =  glue("
select Bitcoin.Date,
       Bitcoin.Price                as Bitcoin_price,
       exchange_China.exchange_rate as USD_Yuan_exchange_rate,
       exchange_Euro.exchange_rate  as USD_Euro_Exchange_Rate,
       DJIA.Price                   as DJIA_index,
       NYSE.Price                   as NYSE_index,
       Apple.Price                  as Apple_price,
       Brent_Oil_price.Price        as brent_oil_price,
       WTI_oil_price.Price          as WTI_oil_price,
       Gold.Price                   as Gold_price,
       President.president_code,
       interest.interest_rate,
       Bitcoin.month,
       Bitcoin.year
from Bitcoin
         left outer join US_dollar_yuan_exchange_rate as exchange_China
                         on exchange_China.Date = Bitcoin.Date
         left outer join Euro_to_US_exchange_rate as exchange_Euro
                         on exchange_Euro.Date = Bitcoin.Date
         left outer join Dow_Jones_Industrial_Average as DJIA
                         on DJIA.Date = Bitcoin.Date
         left outer join NYSE_Composite_Index as NYSE
                         on NYSE.Date = Bitcoin.Date
         left outer join Brent_Oil_price
                         on Brent_Oil_price.Date = Bitcoin.Date
         left outer join WTI_oil_price
                         on WTI_oil_price.Date = Bitcoin.Date
         left outer join Apple_Inc_company_stock as Apple
                         on Apple.Date = Bitcoin.Date
         left outer join President
                         on President.Date = Bitcoin.Date
         left outer join Gold
                         on Gold.Date = Bitcoin.Date
         left outer join The_interest_rate_for_the_United_States as interest
                         on interest.month = Bitcoin.month
                             and interest.year = Bitcoin.year
where Bitcoin.Date between {c (1.0, as.Date('2014-09-01'))[2]} and {c (1.0, as.Date('2020-04-30'))[2]}
order by Bitcoin.Date desc")
combined_daily = sqldf(sql)
combined_daily$Date_posix = c(1, as.Date(combined_daily$Date))[-c(1)]

combined_weekdays = na.omit(combined_daily)
combined_monthly = sqldf("
select *
from combined_daily
where combined_daily.Date in
      (select max(combined_weekdays.Date)
       from combined_weekdays
       group by combined_weekdays.month, combined_weekdays.year)
")
combined_monthly
```
```{r}
str(combined_monthly[, -c(1, 13, 14)])
```



# Results 
The results section should contain numerical or graphical summaries of your results. You should report a final model you have chosen. There is not necessarily one, singular correct model, but certainly some methods and models are better than others in certain situations. You may use any methods we studied this semester to complete this task, and provide evidence that your final choice of model is a good one. Some possible items to be discussed:
```{r}
combined_monthly = na.omit(combined_monthly)
M <- cor(x=combined_monthly[, -c(1, 13, 14)], use = "everything", method="pearson") # get correlations
M
library('corrplot') #package corrplot
corrplot(M, method = "circle")
```


```{r}
gamble_model = lm(Bitcoin_price~ . ,combined_monthly[, -c(1, 13, 14)])
gamble_model_back_aic = step(gamble_model, direction = "backward", trace = 0)
gamble_model_back_aic
```
```{r}
library(leaps)
all_hipcenter_mod = summary(regsubsets(Bitcoin_price ~ ., data = combined_monthly[, -c(1, 13, 14)]))
all_hipcenter_mod
```
```{r}
all_hipcenter_mod$which
all_hipcenter_mod$rss
all_hipcenter_mod$adjr2
```
```{r}
pairs(combined_monthly[, -c(1, 13, 14)], col = "dodgerblue")
```

```{r}
# Date USD_Yuan_exchange_rate USD_Euro_Exchange_Rate DJIA_index NYSE_index Apple_price brent_oil_price WTI_oil_price Gold_price president_code interest_rate
# autompg_big_mod = lm(
#   log(Bitcoin_price) ~ . ^ 2 + I(disp ^ 2) + I(hp ^ 2) + I(wt ^ 2) + I(acc ^ 2), 
#   data = combined_monthly[, -c(13, 14)])
autompg_big_mod = lm(
  log(Bitcoin_price) ~ . ^ 2, 
  data = combined_monthly[, -c(1, 13, 14)])
all_hipcenter_mod = summary(regsubsets(log(Bitcoin_price) ~ ., data = combined_monthly[, -c(1, 13, 14, 15)]))
# autompg_mod_back_aic = step(autompg_big_mod, direction = "backward", trace = 0)
# autompg_mod_back_aic
all_hipcenter_mod
all_hipcenter_mod$which
all_hipcenter_mod$rss
all_hipcenter_mod$adjr2
```
```{r}
# autompg_big_mod = lm(
#   log(Bitcoin_price) ~ . ^ 2 + I(Date_posix ^ 2) + I(USD_Yuan_exchange_rate ^ 2) + I(USD_Euro_Exchange_Rate ^ 2) + I(DJIA_index ^ 2) +  + I(NYSE_index ^ 2) +  + I(Apple_price ^ 2) +  + I(brent_oil_price ^ 2) +  + I(WTI_oil_price ^ 2) + I(Gold_price ^ 2) + I(president_code ^ 2) + I(interest_rate ^ 2), 
#   data = combined_monthly[, -c(1, 13, 14)])
# length(coef(autompg_big_mod))

autompg_big_mod = lm(
  Bitcoin_price ~ . + I(Date_posix ^ 2) + I(USD_Yuan_exchange_rate ^ 2) + I(USD_Euro_Exchange_Rate ^ 2) + I(DJIA_index ^ 2) +  + I(NYSE_index ^ 2) +  + I(Apple_price ^ 2) +  + I(brent_oil_price ^ 2) +  + I(WTI_oil_price ^ 2) + I(Gold_price ^ 2) + I(president_code ^ 2) + I(interest_rate ^ 2), 
  data = combined_monthly[, -c(1, 13, 14)])
length(coef(autompg_big_mod))

# autompg_mod_back_aic = step(autompg_big_mod, direction = "backward", trace = 0)
# autompg_mod_back_aic

n = length(resid(autompg_big_mod))
autompg_mod_back_aic = step(autompg_big_mod, direction = "backward", trace = 0)
length(coef(autompg_mod_back_aic))
autompg_mod_back_aic
autompg_mod_back_bic = step(autompg_big_mod, direction = "backward", 
                            k = log(n), trace = 0)
length(coef(autompg_mod_back_bic))
autompg_mod_back_bic

btc_lm = lm(Bitcoin_price ~ . ,data=combined_monthly[, -c(1, 13, 14)])
autompg_big_mod = lm(
  Bitcoin_price ~ Date_posix + USD_Yuan_exchange_rate +  USD_Euro_Exchange_Rate + DJIA_index + NYSE_index + Apple_price +  I(Date_posix ^ 2) + brent_oil_price + Gold_price + WTI_oil_price +president_code +  interest_rate + I(USD_Yuan_exchange_rate ^ 2) + I(USD_Euro_Exchange_Rate ^ 2) + I(DJIA_index ^ 2) +  + I(NYSE_index ^ 2) +  + I(Apple_price ^ 2) +  + I(brent_oil_price ^ 2) +  + I(WTI_oil_price ^ 2) + I(Gold_price ^ 2) + I(president_code ^ 2) + I(interest_rate ^ 2), 
  data = combined_monthly[, -c(1, 13, 14)])
summary(autompg_big_mod)
```
```{r}
model1 = lm(Bitcoin_price ~ USD_Yuan_exchange_rate + USD_Euro_Exchange_Rate + DJIA_index + brent_oil_price + president_code ,data=combined_monthly[, -c(1, 13, 14)])
summary(btc_lm)
```

```{r}
# data = combined_monthly
n = 500
test_size = 250
trials = 1000
sigmas = c(1,2,4)

# for gambel model
# lm(formula = Bitcoin_price ~ USD_Yuan_exchange_rate + USD_Euro_Exchange_Rate + 
#     DJIA_index + interest_rate + Date_posix, data = combined_monthly[, 
#     -c(1, 13, 14)])
# 
# Coefficients:
#            (Intercept)  USD_Yuan_exchange_rate  USD_Euro_Exchange_Rate              DJIA_index  
#             -31191.893               -2878.941              -14470.975                   0.785  
#          interest_rate              Date_posix  
#              -1160.888                   2.991  
beta_0 = -31191.893
beta_1 = -2878.941
beta_2 = -14470.975
beta_3 = 0.785
beta_4 = -1160.888 
beta_5 = 2.991

x1 = combined_monthly$USD_Yuan_exchange_rate
x2 = combined_monthly$USD_Euro_Exchange_Rate
x3 = combined_monthly$DJIA_index
x4 = combined_monthly$interest_rate
x5 = combined_monthly$Date_posix

x6 = combined_monthly$NYSE_index
x7 = combined_monthly$Apple_price
x8 = combined_monthly$brent_oil_price
x9 = combined_monthly$WTI_oil_price
x10 = combined_monthly$Gold_price
x11 = combined_monthly$president_code

```


```{r}
# Store train_rmse and test_rmse into two matrixs(1000x11): train_error and test_error for each training and each test.

rmse  = function(actual, predicted) {
  sqrt(mean((actual - predicted) ^ 2))
}

simulate_models = function(sigmas,simulation = 1000, dataset = combined_monthly){
  sample_size = nrow(dataset)
  train_error = matrix(rep(0,simulation*11), nrow=simulation, ncol=11)
  test_error = matrix(rep(0,simulation*11), nrow=simulation, ncol=11)
  for(i in 1:simulation) {
    # simulate: true models plus errors
    eps =  rnorm(sample_size, mean = 0 , sd = sigmas)
    sim_y = beta_0 + beta_1 * combined_monthly$USD_Yuan_exchange_rate + beta_2 * combined_monthly$USD_Euro_Exchange_Rate + beta_3 * combined_monthly$DJIA_index + beta_4 * combined_monthly$interest_rate + beta_5 * combined_monthly$Date_posix + eps
    
    sim_data = data.frame(sim_y,x1,x2,x3,x4,x5,x6,x7,x8,x9,x10,x11)
    
    # training: randomly chosen observations
     train_index = sample(1:nrow(sim_data), sample_size/2) 
     experiment_data  = sim_data[train_index, ]
     test_data   = sim_data[-train_index, ]
      fit1 = lm(sim_y ~ x1, data = experiment_data)
      fit2 = lm(sim_y ~ x1+x2, data = experiment_data)
      fit3 = lm(sim_y ~ x1+x2+x3, data = experiment_data)
      fit4 = lm(sim_y ~ x1+x2+x3+x4, data = experiment_data)
      fit5 = lm(sim_y ~ x1+x2+x3+x4+x5, data = experiment_data)
      fit6 = lm(sim_y ~ x1+x2+x3+x4+x5+x6, data = experiment_data)
      fit7 = lm(sim_y ~ x1+x2+x3+x4+x5+x6+x7, data = experiment_data)
      fit8 = lm(sim_y ~ x1+x2+x3+x4+x5+x6+x7+x8, data = experiment_data)
      fit9 = lm(sim_y ~ x1+x2+x3+x4+x5+x6+x7+x8+x9, data = experiment_data)
      fit10 = lm(sim_y ~ x1+x2+x3+x4+x5+x6+x7+x8+x9+x10, data = experiment_data)
      fit11 = lm(sim_y ~ x1+x2+x3+x4+x5+x6+x7+x8+x9+x10+x11, data = experiment_data)
    
    train_error[i,] = c(
      rmse(experiment_data$sim_y, predict(fit1, experiment_data)),
      rmse(experiment_data$sim_y, predict(fit2, experiment_data)),
      rmse(experiment_data$sim_y, predict(fit3, experiment_data)),
      rmse(experiment_data$sim_y, predict(fit4, experiment_data)),
      rmse(experiment_data$sim_y, predict(fit5, experiment_data)),
      rmse(experiment_data$sim_y, predict(fit6, experiment_data)),
      rmse(experiment_data$sim_y, predict(fit7, experiment_data)),
      rmse(experiment_data$sim_y, predict(fit8, experiment_data)),
      rmse(experiment_data$sim_y, predict(fit9, experiment_data)),
      rmse(experiment_data$sim_y, predict(fit10, experiment_data)),
      rmse(experiment_data$sim_y, predict(fit11, experiment_data))
    )
    
    test_error[i,] = c(
      rmse(test_data$sim_y, predict(fit1, test_data)),
      rmse(test_data$sim_y, predict(fit2, test_data)),
      rmse(test_data$sim_y, predict(fit3, test_data)),
      rmse(test_data$sim_y, predict(fit4, test_data)),
      rmse(test_data$sim_y, predict(fit5, test_data)),
      rmse(test_data$sim_y, predict(fit6, test_data)),
      rmse(test_data$sim_y, predict(fit7, test_data)),
      rmse(test_data$sim_y, predict(fit8, test_data)),
      rmse(test_data$sim_y, predict(fit9, test_data)),
      rmse(test_data$sim_y, predict(fit10, test_data)),
       rmse(test_data$sim_y, predict(fit11, test_data))
    )
 }
 result_final = list("train_error" = train_error, "test_error" = test_error)
 result_final
}

```

Finally, we apply different sigmas:

```{r}
re1 = simulate_models(sigmas = 1,simulation = 100, dataset = combined_monthly)
re2 = simulate_models(sigmas = 2,simulation = 100, dataset = combined_monthly)
re3 = simulate_models(sigmas = 4,simulation = 100, dataset = combined_monthly)
```


```{r}
library("plyr")
library("knitr")
opts_chunk$set(fig.show = "hold")
```

```{r}
rmse_train_sig1_means = colMeans(re1$train_error)
rmse_train_sig2_means = colMeans(re2$train_error)
rmse_train_sig4_means = colMeans(re3$train_error)
rmse_test_sig1_means = colMeans(re1$test_error)
rmse_test_sig2_means = colMeans(re2$test_error)
rmse_test_sig4_means = colMeans(re3$test_error)
```



```{r}
plot(Bitcoin_price ~ ., data = combined_monthly[, -c(1, 
    13, 14)], col = "grey", pch = 20, cex = 1.5,
     main = "Bitcoin_price vs possible parameters")
```

```{r}
par(mfrow = c(2,2))
plot(gamble_model, pch = 20)
```



# Discussion
The discussion section should contain discussion of your results and should frame your results in the context of the data. How is your final model useful?

# Appendix
The appendix section should contain code and analysis that is used, but that would have otherwise cluttered the report or is not directly related to the choice of model. Do not simply dump code in here. Only utilize the appendix to supplement the primary focus of the report. The appendix should also conclude with the names of the group members.

Write in complete sentences and pay attention to grammar, spelling, readability and presentation. If you include a table or chart, make sure you say something about it. If you’re not discussing a result, then it doesn’t belong in your report.

Submit the following three items in a .zip file just as you do in homework assignments.

your selected data,
a .Rmd program file,
and the project report (.html file)
# Reference



